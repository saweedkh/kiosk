name: Create Delivery Package

on:
  workflow_dispatch:  # اجرای دستی
  push:
    branches: [ main ]
    paths:
      - 'kiosk_backend/**'
      - 'kiosk_frontend/**'
      - 'nginx/**'
      - 'docker-compose.production.yml'
  release:
    types: [created]

jobs:
  build-package:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build backend image
      run: |
        docker build --no-cache -t kiosk-backend:latest ./kiosk_backend
    
    - name: Build frontend image
      run: |
        docker build --no-cache -t kiosk-frontend:latest ./kiosk_frontend
    
    - name: Build nginx image
      run: |
        docker build --no-cache -t kiosk-nginx:latest ./nginx
    
    - name: Create images directory
      run: mkdir -p images
    
    - name: Save backend image
      run: docker save kiosk-backend:latest -o images/backend.tar
    
    - name: Save frontend image
      run: docker save kiosk-frontend:latest -o images/frontend.tar
    
    - name: Save nginx image
      run: docker save kiosk-nginx:latest -o images/nginx.tar
    
    - name: Create delivery package directory
      run: |
        mkdir -p delivery-package/images
        mkdir -p delivery-package
    
    - name: Copy docker-compose file
      run: cp docker-compose.production.yml delivery-package/docker-compose.yml
    
    - name: Copy run scripts
      run: |
        cp run.bat delivery-package/
        cp stop.bat delivery-package/
        cp rebuild-and-run.bat delivery-package/
        cp rebuild-backend-only.bat delivery-package/
        cp setup-startup.bat delivery-package/
    
    - name: Copy documentation
      run: |
        cp README.txt delivery-package/
        cp NETWORK_ACCESS.md delivery-package/
        cp TROUBLESHOOTING.md delivery-package/
    
    - name: Copy database management scripts
      run: |
        cp backup-database.bat delivery-package/
        cp restore-database.bat delivery-package/
        cp access-database.bat delivery-package/
        cp DATABASE_MANAGEMENT.md delivery-package/
    
    - name: Copy Docker fix scripts
      run: cp fix-docker-safe.bat delivery-package/
    
    - name: Copy alternative docker-compose
      run: cp docker-compose.production.host-network.yml delivery-package/
    
    - name: Copy env.example file
      run: cp kiosk_backend/env.example delivery-package/.env.example
    
    - name: Create default .env file
      run: cp kiosk_backend/env.example delivery-package/.env
    
    - name: Copy images to package
      run: cp -r images/* delivery-package/images/
    
    - name: Install zip utility
      run: sudo apt-get update && sudo apt-get install -y zip
    
    - name: Verify files before ZIP
      run: |
        echo "Verifying files in delivery-package..."
        ls -la delivery-package/*.bat
        ls -la delivery-package/*.md
        echo "Checking specific files:"
        [ -f delivery-package/rebuild-and-run.bat ] && echo "[OK] rebuild-and-run.bat" || echo "[ERROR] rebuild-and-run.bat NOT FOUND!"
        [ -f delivery-package/rebuild-backend-only.bat ] && echo "[OK] rebuild-backend-only.bat" || echo "[ERROR] rebuild-backend-only.bat NOT FOUND!"
        [ -f delivery-package/setup-startup.bat ] && echo "[OK] setup-startup.bat" || echo "[ERROR] setup-startup.bat NOT FOUND!"
        [ -f delivery-package/TROUBLESHOOTING.md ] && echo "[OK] TROUBLESHOOTING.md" || echo "[ERROR] TROUBLESHOOTING.md NOT FOUND!"
    
    - name: Create ZIP archive
      run: |
        rm -f kiosk-app.zip
        cd delivery-package
        zip -r ../kiosk-app.zip .
        cd ..
        ls -lh kiosk-app.zip
        echo "Verifying files in ZIP:"
        unzip -l kiosk-app.zip | grep -E "(rebuild-and-run|rebuild-backend-only|setup-startup|TROUBLESHOOTING)" || echo "WARNING: Some files may not be in ZIP!"
    
    - name: Upload delivery package artifact
      uses: actions/upload-artifact@v4
      with:
        name: kiosk-delivery-package
        path: kiosk-app.zip
        retention-days: 90
    
    - name: Create Release (if tag)
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: kiosk-app.zip
        body: |
          پکیج تحویلی کیوسک آماده است.
          
          این پکیج شامل:
          - Docker Images (backend, frontend, nginx)
          - فایل‌های راه‌اندازی (run.bat, stop.bat, rebuild-and-run.bat, rebuild-backend-only.bat, setup-startup.bat)
          - مستندات (README.txt, NETWORK_ACCESS.md, TROUBLESHOOTING.md)
          - اسکریپت‌های مدیریت دیتابیس (backup-database.bat, restore-database.bat, access-database.bat)
          - اسکریپت‌های رفع مشکل Docker (fix-docker-safe.bat)
          - تنظیمات Docker Compose
          
          برای نصب و راه‌اندازی، فایل README.txt را مطالعه کنید.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

