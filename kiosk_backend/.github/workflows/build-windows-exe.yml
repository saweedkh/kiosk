name: Build Windows EXE

on:
  workflow_dispatch:  # اجرای دستی
  push:
    branches: [ main ]
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Create virtual environment
      run: python -m venv venv
    
    - name: Activate virtual environment
      run: venv\Scripts\activate
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements/base.txt
    
    - name: Run migrations
      run: python manage.py migrate --noinput
    
    - name: Collect static files
      run: python manage.py collectstatic --noinput
    
    - name: Pre-download Dependency Walker
      shell: pwsh
      run: |
        # Create cache directory for Dependency Walker
        $cacheDir = "$env:LOCALAPPDATA\Nuitka\Nuitka\Cache\DOWNLO~1\depends\x86_64"
        New-Item -ItemType Directory -Force -Path $cacheDir | Out-Null
        
        # Download Dependency Walker if not exists
        $dependsExe = "$cacheDir\depends.exe"
        if (-not (Test-Path $dependsExe)) {
          Write-Host "Downloading Dependency Walker..."
          # Download from official source
          $url = "https://www.dependencywalker.com/depends22_x64.zip"
          $zipFile = "$env:TEMP\depends.zip"
          try {
            Invoke-WebRequest -Uri $url -OutFile $zipFile -UseBasicParsing
            Expand-Archive -Path $zipFile -DestinationPath $cacheDir -Force
            Remove-Item $zipFile
            Write-Host "Dependency Walker downloaded successfully"
          } catch {
            Write-Host "Warning: Could not download Dependency Walker automatically. Nuitka will prompt."
          }
        } else {
          Write-Host "Dependency Walker already exists"
        }
    
    - name: Build EXE with Nuitka
      shell: pwsh
      run: |
        python -m nuitka --version
        # Auto-answer "Yes" if prompt appears (in case download failed)
        # Use Write-Output to pipe "Yes" to stdin
        Write-Output "Yes" | python -m nuitka `
            --standalone `
            --onefile `
            --follow-imports `
            --include-data-dir=staticfiles=staticfiles `
            --include-package-data=escpos `
            --windows-console-mode=disable `
            --output-dir=dist `
            --output-filename=kiosk.exe `
            main.py
    
    - name: Upload EXE artifact
      uses: actions/upload-artifact@v4
      with:
        name: kiosk-windows-exe
        path: dist/kiosk.exe
        retention-days: 30
    
    - name: Create Release (if tag)
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/kiosk.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

